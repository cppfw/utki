branches:
  only:
    - master

os: Visual Studio 2017
version: "{branch}-{build}"

clone_folder: c:\build

environment:
  BASH: C:\msys64\usr\bin\env MSYSTEM=msys C:\msys64\usr\bin\bash
  MYCI_BINTRAY_API_KEY:
    secure: t04W/09OyK0B8CxJHydCkay+Fm3i6KkBciVXjzk0u09v6F9wtDn/dsuqd5eMIj8s

install:
  - cmd: "%BASH% -lc \"echo -e '[pacman]\\nSigLevel = Optional TrustAll\\nServer = https://dl.bintray.com/igagis/msys2/mingw/$arch' >> /etc/pacman.conf\""
  - cmd: "%BASH% -lc \"pacman -Sy --noconfirm myci\""
  - ps: (new-object net.webclient).DownloadFile('http://coapp.org/files/CoApp.Tools.Powershell.msi', 'C:\CoApp.Tools.Powershell.msi')
  - ps: Start-Process -FilePath msiexec -ArgumentList /i, 'C:\CoApp.Tools.Powershell.msi', /quiet -Wait
  - ps: $env:PSModulePath = $env:PSModulePath + ';C:\Program Files (x86)\Outercurve Foundation\Modules'
  - ps: Import-Module CoApp

before_build:
  - nuget restore msvs_solution/msvs_solution.sln

build_script:
  - cmd: "%BASH% -lc \"cd /c/build/ && myci-apply-version.sh -v `myci-deb-version.sh debian/changelog` msys2/PKGBUILD.in\""
  - cmd: "%BASH% -lc \"cd /c/build/msys2 && MINGW_INSTALLS=mingw64 makepkg-mingw --syncdeps --noconfirm --skipinteg\""
  - ps: .\nuget\build_nuget.ps1

test_script:
#  - ps: .\tests\autotest-appveyor.ps1

before_deploy:
- cmd: if "%APPVEYOR_REPO_TAG%"=="true" (%BASH% -lc "cd /c/build && myci-deploy-pacman-bintray.sh -u igagis -r msys2 -p mingw/x86_64 msys2/*.tar.xz") else (echo Skipping deploy because not a tagged commit.)

deploy:
  provider: NuGet
  api_key:
    secure: cvBwlGzXt2fwZB1AFv+aJZca9hCQf4hW/BYwKOjCjCx0WFD9L6g9e2IH7SZ+P0Qf
  skip_symbols: true
  artifact: /.*\.nupkg/
  on:
    appveyor_repo_tag: true

artifacts:
  - path: .\nuget\*.nupkg
  - path: .\msys2\*.tar.xz
